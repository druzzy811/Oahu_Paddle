<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Gallery — My Oceanic Odyssey</title>
  <meta name="description" content="A photo gallery tied to the exact places each image was made." />

  <!-- Your shared stylesheet -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

  <style>
    /* Toolbar */
    .toolbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding: clamp(12px,2.5vw,16px);
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .btn-tab{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px;
      border:1px solid var(--stroke); color:var(--text); background:rgba(255,255,255,.06);
      font-weight:700; cursor:pointer; user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn-tab:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12) }
    .btn-tab.active{ outline:2px solid var(--aqua); background:rgba(255,255,255,.14) }

    .chipbar{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{
      background: rgba(1,29,48,.85); color: var(--foam);
      border:1px solid rgba(255,255,255,.18);
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; cursor:pointer;
      user-select:none;
    }
    .chip.active{ background:linear-gradient(135deg, var(--aqua), var(--sun)); color:#0b1f29; border-color:transparent }

    /* Layout */
    .gallery-shell{ display:grid; grid-template-columns: 1fr; gap:0; position:relative; }
    .panel{ min-height: 50vh }
    .panel.map{ position:relative; }
    #map{ height: 100%; width: 100%; }
    .map-topbar{
      position:absolute; top:10px; left:10px; right:10px; z-index:500;
      display:flex; align-items:center; justify-content:flex-end; gap:8px; pointer-events:none;
    }
    .map-topbar > *{ pointer-events:auto }

    /* Masonry grid */
    .grid{ column-count: 3; column-gap: 12px; padding: clamp(12px, 2vw, 18px); }
    @media (max-width: 1020px){ .grid{ column-count: 2 } }
    @media (max-width: 640px){ .grid{ column-count: 1 } }

    .item{
      display:block; break-inside: avoid; margin: 0 0 12px; position:relative;
      border-radius:12px; overflow:hidden; border:1px solid var(--stroke);
      background: rgba(255,255,255,.04); box-shadow: var(--shadow); cursor:pointer;
      transition: transform .12s ease;
    }
    .item:hover{ transform: translateY(-1px) }
    .item img{ width:100%; height:auto; display:block }
    .stamp{
      position:absolute; left:8px; bottom:8px;
      font-size:12px; color:#fff; background:rgba(0,0,0,.45); padding:4px 8px; border-radius:999px;
    }
    .item.active{ outline:2px solid var(--aqua) }

    /* Marker thumbnails */
    .pin{
      width:40px; height:40px; border-radius:999px; border:2px solid rgba(255,255,255,.6);
      background-size:cover; background-position:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.45);
    }
    .leaflet-popup-content img{
      border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.35);
      display:block; width:300px; max-height:360px; object-fit:cover;
    }

    /* Lightbox */
    .lightbox{
      position:fixed; inset:0; z-index:1200; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.85);
    }
    .lightbox.open{ display:flex }
    .lightbox img{ max-width:92vw; max-height:88vh; border-radius:12px; border:1px solid rgba(255,255,255,.25);
      box-shadow:0 20px 60px rgba(0,0,0,.6) }
    .lb-btn, .lb-close{
      position:absolute; display:flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:999px; border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.08); color:#fff; font-size:18px; cursor:pointer;
    }
    .lb-prev{ left:24px; top:50%; transform:translateY(-50%) }
    .lb-next{ right:24px; top:50%; transform:translateY(-50%) }
    .lb-close{ right:24px; top:24px }

    .inline-error{
      position:fixed; bottom:12px; left:12px; z-index:1400;
      background:rgba(120,0,0,.9); color:#fff; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.35); font-weight:700; box-shadow:0 10px 24px rgba(0,0,0,.45);
      max-width: 90vw;
    }
  </style>
</head>

<body>
  <!-- Background -->
  <div class="ocean-bg" aria-hidden="true"></div>
  <div class="ocean-noise" aria-hidden="true"></div>

  <!-- Header -->
  <header class="site-header">
    <button class="hamburger" id="hamburger" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>

    <a class="brand" href="index.html" aria-label="My Oceanic Odyssey">
      <svg class="brand-icon" viewBox="0 0 64 64" aria-hidden="true">
        <path d="M4.00,16.20 L6.84,17.85 L7.55,18.82 L8.35,19.50 L8.63,20.96 L8.40,24.35 L9.39,24.97 L9.52,25.67 L9.98,26.16 L9.83,26.37 L10.29,26.26 L10.83,26.51 L10.89,26.88 L12.02,27.60 L12.09,27.83 L11.85,28.11 L12.09,28.08 L12.64,29.02 L12.94,29.20 L13.05,31.09 L13.29,31.62 L14.78,32.26 L16.24,33.70 L16.37,34.15 L16.81,34.42 L17.34,35.59 L17.98,38.41 L18.84,40.27 L19.44,40.85 L21.23,40.91 L21.84,40.68 L24.32,40.45 L30.93,39.04 L31.36,38.64 L31.49,38.12 L31.33,38.02 L30.91,38.47 L31.35,37.94 L31.30,37.40 L30.50,36.25 L29.58,36.23 L29.44,35.81 L28.68,35.92 L28.17,35.48 L28.00,35.61 L27.61,35.41 L27.03,35.49 L27.14,35.43 L26.84,35.10 L26.98,34.76 L27.43,34.71 L27.11,34.41 L27.05,34.00 L27.35,34.07 L27.63,33.62 L27.72,34.05 L27.92,33.69 L27.79,34.03 L28.09,33.99 L28.16,34.23 L28.28,34.07 L28.59,34.31 L28.44,34.58 L28.84,35.03 L28.87,35.47 L29.96,35.02 L29.91,35.41 L29.48,35.48 L29.86,35.96 L30.57,35.94 L31.41,36.83 L31.28,36.12 L31.47,35.85 L31.00,35.12 L31.10,34.72 L30.37,34.68 L29.65,33.62 L29.56,32.84 L30.28,32.69 L30.38,33.20 L31.07,33.59 L30.99,33.87 L31.55,34.33 L31.83,33.78 L31.60,32.91 L32.30,32.72 L34.06,33.48 L33.94,33.74 L34.08,33.87 L34.69,33.73 L34.75,33.90 L34.19,34.63 L34.60,34.86 L35.50,34.22 L36.05,34.42 L35.53,34.22 L34.70,34.91" fill="none" vector-effect="non-scaling-stroke"/>
      </svg>
      <span class="brand-text">My Oceanic Odyssey</span>
    </a>

    <nav class="main-nav">
      <a href="introduction.html">Introduction</a>
      <a href="science.html">Science</a>
      <a href="gallery.html" aria-current="page">Gallery</a>
      <a href="support.html">Support</a>
      <a href="about.html">About</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="wrap">
    <!-- Hero -->
    <section class="card intro-hero">
      <div class="intro-hero__content">
        <h1>Photo Gallery</h1>
        <p class="lead">Images first. Every frame is anchored to its real place. Explore by picture or by map.</p>
      </div>
    </section>

    <!-- Controls -->
    <section class="card toolbar" role="region" aria-label="Gallery controls">
      <div class="view-tabs" role="tablist" aria-label="View mode">
        <button class="btn-tab active" id="tabGrid" aria-selected="true">Grid</button>
        <button class="btn-tab" id="tabMap" aria-selected="false">Map</button>
      </div>
      <div style="flex:1"></div>
      <div class="chipbar" id="yearChips" aria-label="Filter by year"></div>
    </section>

    <!-- Gallery + Map -->
    <section class="card gallery-shell" id="galleryShell">
      <!-- Map panel -->
      <div class="panel map" id="mapPanel" hidden>
        <div class="map-topbar">
          <span class="chip" id="countChip">0 photos</span>
        </div>
        <div id="map"></div>
      </div>

      <!-- Grid panel -->
      <div class="panel grid" id="gridPanel">
        <div class="grid" id="grid"></div>
      </div>
    </section>
  </main>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <button class="lb-close" id="lbClose" aria-label="Close">&times;</button>
    <button class="lb-btn lb-prev" id="lbPrev" aria-label="Previous">&#10094;</button>
    <img id="lbImg" alt="Photo" />
    <button class="lb-btn lb-next" id="lbNext" aria-label="Next">&#10095;</button>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="social">
      <a aria-label="Instagram" href="https://www.instagram.com/drewski1003" target="_blank"><i class="fab fa-instagram"></i></a>
      <a aria-label="Medium" href="https://medium.com/my-oceanic-odyssey" target="_blank"><i class="fab fa-medium"></i></a>
      <a aria-label="Substack" href="https://substack.com/@drewburrier" target="_blank"><i class="fas fa-newspaper"></i></a>
      <a aria-label="LinkedIn" href="https://www.linkedin.com/in/drew-burrier-90092067/" target="_blank"><i class="fab fa-linkedin-in"></i></a>
      <a aria-label="Spotify" href="https://open.spotify.com/user/12148616871" target="_blank"><i class="fab fa-spotify"></i></a>
    </div>
    <div class="legal">© My Oceanic Odyssey</div>
  </footer>

  <!-- Map JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- YOUR REAL DATA (must be before the loader below) -->
  <script src="Gallery/photos.js"></script>

  <!-- Robust loader: supports const/let/var and window attachment -->
  <script>
    (function(){
      let DATA = null;
      if (typeof photoData !== 'undefined' && Array.isArray(photoData)) DATA = photoData;
      if (!Array.isArray(DATA) && typeof window.photoData !== 'undefined' && Array.isArray(window.photoData)) DATA = window.photoData;
      if (!Array.isArray(DATA)) {
        const warn = document.createElement('div');
        warn.className = 'inline-error';
        warn.textContent = 'Gallery/photos.js did not load or does not define `const photoData = [...]`. Fix the path/case and reload.';
        document.body.appendChild(warn);
      }
      window.__PHOTOS__ = Array.isArray(DATA) ? DATA : [];
    })();
  </script>

  <!-- Page logic -->
  <script>
  (function(){
    const DATA = window.__PHOTOS__;
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const imgPath = f => `Gallery/${f}`;
    const yearOf  = p => (p?.datetime || '').slice(0,4);
    const fmtDate = s => (s||'').split(' ')[0].replaceAll(':','-');

    const gridPanel = $('#gridPanel');
    const mapPanel  = $('#mapPanel');
    const gridEl    = $('#grid');
    const countChip = $('#countChip');

    let currentIndex = 0;

    // Build Grid
    function buildGrid(list){
      gridEl.innerHTML = '';
      list.forEach((p,i)=>{
        const fig = document.createElement('figure');
        fig.className = 'item';
        fig.dataset.index = i;
        fig.dataset.year  = yearOf(p)||'';
        fig.innerHTML = `
          <img src="${imgPath(p.filename)}" alt="Photo ${fmtDate(p.datetime)}" loading="lazy">
          <figcaption class="stamp">${fmtDate(p.datetime)}</figcaption>
        `;
        fig.addEventListener('click', ()=>{
          openLightbox(i);
          focusOnMap(i);
          highlightGrid(i);
        });
        gridEl.appendChild(fig);
      });
    }

    function highlightGrid(i){
      $$('.item').forEach(el => el.classList.toggle('active', +el.dataset.index === i));
      const active = $('.item.active');
      if (active && mapPanel.hidden){ active.scrollIntoView({behavior:'smooth', block:'center'}); }
    }

    // Map
    let map, markerGroup;
    function initMap(){
      if (map) return;
      map = L.map('map', { zoomControl:true }).setView([21.466883, -157.942441], 10);
      const google = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '© Google'
      }).addTo(map);
      google.on('tileerror', function(){
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
          maxZoom:19, attribution:'© OpenStreetMap'
        }).addTo(map);
      });

      markerGroup = L.featureGroup().addTo(map);
      DATA.forEach((p,i)=>{
        const lat=p?.gps?.latitude, lon=p?.gps?.longitude;
        if (typeof lat !== 'number' || typeof lon !== 'number') return;
        const div = L.divIcon({
          className: 'thumb-pin',
          html: `<div class="pin" style="background-image:url('${imgPath(p.filename)}')"></div>`,
          iconSize: [40,40], iconAnchor: [20,20], popupAnchor: [0,-10]
        });
        const m = L.marker([lat, lon], { icon: div }).addTo(markerGroup);
        m.on('click', ()=> { currentIndex = i; openPopup(i); highlightGrid(i); });
      });

      if (markerGroup.getLayers().length){
        map.fitBounds(markerGroup.getBounds(), { padding:[40,40] });
      }
      countChip.textContent = `${DATA.length} photos`;
    }

    function openPopup(i){
      const p = DATA[i]; if (!p) return;
      const lat = p.gps.latitude, lon = p.gps.longitude;
      const html = `
        <div style="display:flex;align-items:center;justify-content:space-between;width:300px;margin:0;padding:0;background:rgba(255,255,255,.5)">
          <div style="width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;border-right:12px solid #A3C6C4;cursor:pointer;margin-left:-5px;margin-right:6px;" onclick="navigatePhoto(${i-1})"></div>
          <div style="text-align:center;flex-grow:1;margin:0;">
            <img src="${imgPath(p.filename)}" alt="Photo ${fmtDate(p.datetime)}" style="cursor:zoom-in" onclick="openLightbox(${i})">
          </div>
          <div style="width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;border-left:12px solid #A3C6C4;cursor:pointer;margin-right:-5px;margin-left:6px;" onclick="navigatePhoto(${i+1})"></div>
        </div>
      `;
      L.popup({ maxWidth:420, autoPan:true })
        .setLatLng([lat, lon]).setContent(html).openOn(map);
      setTimeout(()=>{ map.panBy([0, -Math.round(map.getSize().y*0.18)], {animate:true}); }, 40);
    }

    function focusOnMap(i){
      if (!map) return;
      const p = DATA[i]; if (!p) return;
      map.setView([p.gps.latitude, p.gps.longitude], Math.max(map.getZoom(), 11), { animate:true });
      openPopup(i);
    }

    // expose for popup arrows
    window.navigatePhoto = function(i){
      if (!DATA.length) return;
      if (i < 0) i = DATA.length - 1;
      if (i >= DATA.length) i = 0;
      currentIndex = i;
      openPopup(i);
      highlightGrid(i);
      const el = document.querySelector(`.item[data-index="${i}"]`);
      if (el && gridPanel && !gridPanel.hidden) el.scrollIntoView({behavior:'smooth', block:'center'});
    };

    // Year filters
    const chips = $('#yearChips'); chips.innerHTML = '';
    const years = Array.from(new Set(DATA.map(yearOf).filter(Boolean))).sort();
    const activeYears = new Set(years);
    years.forEach(y=>{
      const c = document.createElement('button');
      c.className = 'chip active'; c.textContent = y;
      c.onclick = () => { activeYears.has(y) ? activeYears.delete(y) : activeYears.add(y); c.classList.toggle('active'); applyYearFilter(); };
      chips.appendChild(c);
    });

    function applyYearFilter(){
      // Grid
      $$('.item').forEach(el=>{
        const show = activeYears.has(el.dataset.year);
        el.style.display = show ? '' : 'none';
      });
      // Map
      if (map && markerGroup){
        markerGroup.clearLayers();
        DATA.forEach((p,i)=>{
          if (!activeYears.has(yearOf(p))) return;
          const lat=p?.gps?.latitude, lon=p?.gps?.longitude;
          if (typeof lat !== 'number' || typeof lon !== 'number') return;
          const div = L.divIcon({
            className: 'thumb-pin',
            html: `<div class="pin" style="background-image:url('${imgPath(p.filename)}')"></div>`,
            iconSize: [40,40], iconAnchor: [20,20], popupAnchor: [0,-10]
          });
          const m = L.marker([lat, lon], { icon: div }).addTo(markerGroup);
          m.on('click', ()=> { currentIndex = i; openPopup(i); highlightGrid(i); });
        });
        if (markerGroup.getLayers().length) map.fitBounds(markerGroup.getBounds(), { padding:[40,40] });
      }
      const visible = $$('.item').filter(el=>el.style.display!=='none').length;
      countChip.textContent = `${visible} photos`;
    }

    // Lightbox
    const lightbox = $('#lightbox');
    const lbImg    = $('#lbImg');
    $('#lbClose').onclick = closeLightbox;
    $('#lbPrev').onclick  = ()=>{ navigatePhoto(currentIndex-1); openLightbox(currentIndex); };
    $('#lbNext').onclick  = ()=>{ navigatePhoto(currentIndex+1); openLightbox(currentIndex); };
    function openLightbox(i){
      if (!DATA[i]) return;
      currentIndex = i;
      lbImg.src = imgPath(DATA[i].filename);
      lightbox.classList.add('open'); lightbox.setAttribute('aria-hidden','false');
    }
    function closeLightbox(){
      lightbox.classList.remove('open'); lightbox.setAttribute('aria-hidden','true'); lbImg.src='';
    }
    window.openLightbox = openLightbox;

    document.addEventListener('keydown', (e)=>{
      const open = lightbox.classList.contains('open');
      if (e.key === 'ArrowRight'){ navigatePhoto(currentIndex+1); if(open) openLightbox(currentIndex); }
      if (e.key === 'ArrowLeft'){  navigatePhoto(currentIndex-1); if(open) openLightbox(currentIndex); }
      if (e.key === 'Escape' && open){ closeLightbox(); }
    });

    // View tabs (Grid / Map)
    const tabGrid = $('#tabGrid');
    const tabMap  = $('#tabMap');
    function setTabs(active){
      [tabGrid, tabMap].forEach(b => b.classList.toggle('active', b === active));
      if (active === tabGrid){
        gridPanel.hidden = false; mapPanel.hidden = true;
      } else {
        gridPanel.hidden = true; mapPanel.hidden = false;
        initMap(); setTimeout(()=>map.invalidateSize(), 60);
      }
    }
    tabGrid.onclick = ()=> setTabs(tabGrid);
    tabMap.onclick  = ()=> setTabs(tabMap);

    // Boot
    buildGrid(DATA);
    applyYearFilter();
    setTabs(tabGrid);
    if (DATA.length) highlightGrid(0);

    // Minimal drawer (optional if you already have it globally)
    const drawer    = document.getElementById('drawer');
    const closeBtn  = document.getElementById('drawerClose');
    const backdrop  = document.getElementById('backdrop');
    const main      = document.querySelector('main');
    const footer    = document.querySelector('footer');
    const burger    = document.getElementById('hamburger');
    function setInert(on){ if (on){ main?.setAttribute('inert',''); footer?.setAttribute('inert',''); } else { main?.removeAttribute('inert'); footer?.removeAttribute('inert'); } }
    function openDrawer(){ drawer.hidden=false; backdrop.hidden=false; drawer.classList.add('open'); setInert(true); burger.setAttribute('aria-expanded','true'); }
    function closeDrawer(){ drawer.classList.remove('open'); drawer.hidden=true; backdrop.hidden=true; setInert(false); burger.setAttribute('aria-expanded','false'); }
    function trapFocus(e){
      if (e.key !== 'Tab' || drawer.hidden) return;
      const focusables = drawer.querySelectorAll('a[href],button:not([disabled]),[tabindex]:not([tabindex="-1"])');
      if (!focusables.length) return;
      const first = focusables[0]; const last = focusables[focusables.length-1];
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    burger.addEventListener('click', openDrawer);
    closeBtn?.addEventListener('click', closeDrawer);
    backdrop?.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeDrawer(); trapFocus(e); });
  })();
  </script>

  <!-- Drawer markup -->
  <aside id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Site menu" hidden>
    <div class="drawer-header">
      <strong>Navigate</strong>
      <button class="drawer-close" id="drawerClose" aria-label="Close menu">&times;</button>
    </div>
    <div class="drawer-section">
      <a href="introduction.html">Introduction</a>
      <a href="about.html">About the Author</a>
      <a href="landing.html">Landing Page</a>
      <a href="science.html">Open Oceanography</a>
      <a href="gallery.html" aria-current="page">Photo Map</a>
      <a href="freelance.html">Work With Me</a>
      <a class="sponsor-cta" href="support.html">Sponsor the Journey</a>
    </div>
  </aside>
  <div id="backdrop" class="backdrop" hidden></div>
</body>
</html>
